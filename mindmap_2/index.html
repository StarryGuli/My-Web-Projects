<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>56ä¸ªæ°‘æ—ï¼ˆè’™å¤æ—ï¼‰- æ·±åº¦å®šåˆ¶ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
    /* åŸºç¡€å¸ƒå±€ */
    body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: #f5f7fa; /* ç½‘é¡µèƒŒæ™¯è‰²ï¼Œå¯¼å‡ºæ—¶ä¼šè¢«å¿½ç•¥ */
        font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    /* å¯¼å›¾å®¹å™¨ */
    #app {
        width: 100vw;
        height: 100vh;
        transition: width 0.3s;
    }

    /* --- å³ä¾§ä¾§è¾¹æ  --- */
    .sidebar {
        position: absolute;
        top: 0;
        right: 0;
        width: 340px; /* ç¨å¾®åŠ å®½ä¸€ç‚¹ä»¥æ˜¾ç¤ºçˆ¶çº§å¤‡æ³¨ */
        height: 100%;
        background: white;
        box-shadow: -5px 0 15px rgba(0,0,0,0.05);
        z-index: 100;
        display: flex;
        flex-direction: column;
        border-left: 1px solid #eee;
    }

    .sidebar-header {
        padding: 20px;
        background: #fff;
        border-bottom: 1px solid #eee;
    }

    .sidebar-header h2 {
        margin: 0 0 15px 0;
        font-size: 18px;
        color: #333;
        font-weight: 600;
    }

    /* é…ç½®ç»„ */
    .config-group {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .config-group label { font-size: 14px; color: #666; }
    input[type="color"] { border: none; width: 50px; height: 28px; cursor: pointer; background: none; }
    select, input[type="range"] { padding: 4px; border-radius: 4px; border: 1px solid #ddd; font-size: 13px; }

    /* èŠ‚ç‚¹åˆ—è¡¨ (æ»šåŠ¨åŒº) */
    .node-list-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px 20px;
        background: #fafafa;
    }
    
    .list-title {
        font-size: 12px;
        color: #999;
        margin: 10px 0;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .node-item {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 13px;
        color: #555;
        cursor: pointer;
    }
    .node-item:hover { background-color: #f0f0f0; }
    .node-item input { margin-right: 10px; cursor: pointer; }
    
    .node-content { display: flex; flex-direction: column; line-height: 1.4; }
    .node-parent-hint { font-size: 11px; color: #999; margin-top: 2px; }

    /* åº•éƒ¨æŒ‰é’®åŒº */
    .sidebar-footer {
        padding: 15px 20px;
        border-top: 1px solid #eee;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .btn {
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }
    .btn-reset { background-color: #f1f3f4; color: #555; }
    .btn-reset:hover { background-color: #e0e2e4; }
    
    .btn-export { background-color: #2ecc71; color: white; font-weight: bold; }
    .btn-export:hover { background-color: #27ae60; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }

</style>
</head>
<body>

<div id="app">
    <svg id="mindmap" style="width:100%; height:100%"></svg>
</div>

<div class="sidebar">
    <div class="sidebar-header">
        <h2>ğŸ›  è‡ªç”±å®šåˆ¶ä¸å¯¼å‡º</h2>
        
        <div class="config-group">
            <label>å¼ºè°ƒé¢œè‰²</label>
            <input type="color" id="colorPicker" value="#d63031" onchange="renderMap()">
        </div>

        <div class="config-group">
            <label>å¼ºè°ƒæ ·å¼</label>
            <select id="styleMode" onchange="renderMap()">
                <option value="text">åŠ ç²—å˜è‰²</option>
                <option value="background">è§å…‰ç¬”é«˜äº®</option>
                <option value="border">è¾¹æ¡†åœˆæ³¨</option>
            </select>
        </div>
        
         <div class="config-group">
            <label>å±•å¼€å±‚çº§</label>
             <input type="range" id="depthRange" min="1" max="4" step="1" value="2" oninput="renderMap()">
        </div>
    </div>

    <div class="node-list-container">
        <div class="list-title">å‹¾é€‰å†…å®¹è¿›è¡Œå¼ºè°ƒï¼š</div>
        <div id="checklist"></div>
    </div>

    <div class="sidebar-footer">
        <button class="btn btn-reset" onclick="resetSelection()">â†º é‡ç½®å‹¾é€‰</button>
        <button class="btn btn-export" onclick="exportImage()">ğŸ“¸ å¯¼å‡ºé€æ˜èƒŒæ™¯æˆªå›¾</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.4"></script>
<script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.4/dist/browser/index.min.js"></script>

<script>
    // --- 1. æ•°æ®æºä¸è§£æé€»è¾‘ ---

    // åŸå§‹ Markdown å­—ç¬¦ä¸²
    const rawMarkdownSource = `
# 56ä¸ªæ°‘æ—<br/>(è’™å¤æ—)
## æ•´ä½“æ´»åŠ¨ï¼šåˆè¯†è’™å¤æ—
## æ´»åŠ¨ä¸€ï¼šè’™å¤æ—å¾‹åŠ¨ï¼ˆæŸ”è‡‚ï¼‰
- æ¬£èµæ­Œæ›²ã€Šç‰§æ­Œã€‹
- å­¦ä¹ è’™å¤æ—å¾‹åŠ¨ï¼šæŸ”è‡‚
- å·©å›ºæå‡
## æ´»åŠ¨äºŒï¼šå¾‹åŠ¨æ¸¸æˆ<br/>â€œé‚£è¾¾æ…•å¤§ä¼šâ€ï¼ˆç¬‘è‚©ï¼‰
- æ¬£èµæ­Œæ›²ã€Šè’™å¤èµ°é©¬èˆã€‹
- å­¦ä¹ è’™å¤æ—å¾‹åŠ¨ï¼šç¬‘è‚©
    - å¯¼å…¥
        - çƒ­èº«
        - å¯¼å…¥ï¼šç…§ç‰‡
        - æ¬£èµè’™å¤èˆ
    - æ–°æˆ
        - å­¦ä¹ åŠ¨ä½œè¦é¢†
        - æ¨¡ä»¿ç»ƒä¹ 
        - è·ŸéŸ³ä¹ç»ƒä¹ 
    - å·©å›ºæå‡
        - æƒ…æ™¯åˆ›è®¾
        - æ•™å¸ˆå¼•é¢†
        - å­¦ç”Ÿè‡ªä¸»å‚ä¸
- é‚£è¾¾æ…•å¤§ä¼šï¼ˆæå‡ï¼Œæ‹“å±•ï¼‰
## ç»Ÿæ•´æ´»åŠ¨ï¼šèˆæ—å¤§ä¼š<br/>ï¼ˆè’™å¤å¾‹åŠ¨å±•ç¤ºï¼‰
`;

    // å­˜å‚¨è§£æåçš„è¡Œå¯¹è±¡ç»“æ„
    let parsedLines = [];
    // å­˜å‚¨è¢«å‹¾é€‰çš„è¡Œçš„ç´¢å¼• (Set<Index>)
    let checkedIndices = new Set();

    // è§£æ Markdownï¼Œæ„å»ºå¸¦æœ‰å±‚çº§ä¸Šä¸‹æ–‡çš„å¯¹è±¡æ•°ç»„
    function parseMarkdown() {
        const lines = rawMarkdownSource.split('\n');
        const result = [];
        const stack = []; // ç”¨äºè¿½è¸ªçˆ¶çº§

        lines.forEach((line, index) => {
            if (!line.trim()) {
                result.push({ text: line, type: 'empty', index });
                return;
            }

            // è®¡ç®—ç¼©è¿›å±‚çº§ (å‡è®¾æ˜¯ç©ºæ ¼ç¼©è¿›æˆ– # å·å±‚çº§)
            let level = 0;
            let content = line;
            
            // å¤„ç† # æ ‡é¢˜
            const headerMatch = line.match(/^(#+)\s/);
            if (headerMatch) {
                level = headerMatch[1].length - 1; // # æ˜¯ 0çº§, ## æ˜¯ 1çº§
                content = line.replace(/^(#+)\s/, '');
            } else {
                // å¤„ç†åˆ—è¡¨ - 
                const listMatch = line.match(/^(\s*)-\s/);
                if (listMatch) {
                    // å‡è®¾æ¯4ä¸ªç©ºæ ¼æˆ–1ä¸ªtabæ˜¯ä¸€çº§ï¼Œç²—ç•¥è®¡ç®—ï¼Œç»“åˆ # çš„å±‚çº§
                    const spaces = listMatch[1].length;
                    level = 1 + Math.floor(spaces / 4); // åŸºç¡€å±‚çº§ä¸º1 (## ä¸‹é¢)
                    content = line.replace(/^(\s*)-\s/, '');
                } else {
                     // çº¯æ–‡æœ¬æˆ–å…¶ä»–
                     result.push({ text: line, type: 'raw', index });
                     return;
                }
            }

            // ç»´æŠ¤æ ˆä»¥è·å–çˆ¶çº§åç§°
            stack[level] = content;
            // æ¸…é™¤æ¯”å½“å‰å±‚çº§æ›´æ·±çš„è®°å½•
            stack.splice(level + 1);

            // è·å–ç›´æ¥çˆ¶çº§åç§° (ç”¨äº UI åŒºåˆ†åŒåèŠ‚ç‚¹)
            const parentName = level > 0 ? stack[level - 1] : '';

            result.push({
                originalLine: line,
                cleanText: content.trim(),
                level: level,
                parent: parentName ? parentName.replace(/<br\/>/g, ' ') : null,
                index: index,
                type: 'node'
            });
        });
        return result;
    }

    // --- 2. åˆå§‹åŒ–ä¸äº¤äº’ ---

    function init() {
        parsedLines = parseMarkdown();
        
        // é»˜è®¤å‹¾é€‰åˆ—è¡¨ (é€šè¿‡æ–‡æœ¬åŒ¹é…ç´¢å¼•ï¼Œåˆå§‹åŒ–ä¸€æ¬¡)
        // è¿™é‡Œæ‰‹åŠ¨æŒ‡å®šè¦é»˜è®¤å‹¾é€‰çš„å†…å®¹ï¼Œæ¨¡æ‹Ÿæ™ºèƒ½è¯†åˆ«
        parsedLines.forEach(item => {
            if (item.type !== 'node') return;
            const t = item.cleanText;
            // é»˜è®¤å‹¾é€‰é€»è¾‘ï¼šæ´»åŠ¨äºŒåŠå…¶ä¸‹å±å…³é”®ç‚¹
            if (t.includes('æ´»åŠ¨äºŒ') || 
                t === 'å­¦ä¹ è’™å¤æ—å¾‹åŠ¨ï¼šç¬‘è‚©' || 
                t === 'å¯¼å…¥' || 
                t === 'æ–°æˆ' || 
                // åªå‹¾é€‰ æ´»åŠ¨äºŒ ä¸‹é¢çš„ å·©å›ºæå‡
                (t === 'å·©å›ºæå‡' && item.parent && item.parent.includes('ç¬‘è‚©')) 
               ) {
                checkedIndices.add(item.index);
            }
        });

        renderChecklist();
        renderMap();
    }

    // æ¸²æŸ“å³ä¾§å‹¾é€‰åˆ—è¡¨
    function renderChecklist() {
        const container = document.getElementById('checklist');
        container.innerHTML = '';

        parsedLines.forEach(item => {
            // åªæ˜¾ç¤ºæœ‰å®é™…å†…å®¹çš„èŠ‚ç‚¹ï¼Œè·³è¿‡æ ¹æ ‡é¢˜(level 0)
            if (item.type !== 'node' || item.level === 0) return;

            const div = document.createElement('div');
            div.className = 'node-item';
            div.onclick = (e) => {
                if (e.target.tagName !== 'INPUT') {
                    const cb = div.querySelector('input');
                    cb.checked = !cb.checked;
                    toggleIndex(item.index, cb.checked);
                }
            };

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = checkedIndices.has(item.index);
            checkbox.onchange = (e) => toggleIndex(item.index, e.target.checked);

            // å†…å®¹åŒºåŸŸ
            const contentDiv = document.createElement('div');
            contentDiv.className = 'node-content';
            
            const textSpan = document.createElement('span');
            textSpan.innerText = item.cleanText.replace(/<br\/>/g, ' ');
            
            contentDiv.appendChild(textSpan);

            // å¦‚æœæ˜¯åŒåæ˜“æ··æ·†èŠ‚ç‚¹ï¼ˆå¦‚â€œå·©å›ºæå‡â€ï¼‰ï¼Œæ˜¾ç¤ºçˆ¶çº§æç¤º
            if (['å·©å›ºæå‡', 'å¯¼å…¥', 'æ–°æˆ', 'çƒ­èº«'].includes(item.cleanText)) {
                const hint = document.createElement('span');
                hint.className = 'node-parent-hint';
                hint.innerText = item.parent ? `æ‰€å±ï¼š${item.parent}` : '';
                contentDiv.appendChild(hint);
            }

            div.appendChild(checkbox);
            div.appendChild(contentDiv);
            container.appendChild(div);
        });
    }

    function toggleIndex(index, isChecked) {
        if (isChecked) checkedIndices.add(index);
        else checkedIndices.delete(index);
        renderMap();
    }

    function resetSelection() {
        checkedIndices.clear();
        renderChecklist();
        renderMap();
    }

    // --- 3. æ¸²æŸ“æ€ç»´å¯¼å›¾ ---
    
    const { Transformer } = window.markmap;
    const { Markmap, loadCSS, loadJS } = window.markmap;
    const transformer = new Transformer();
    let mm = null;

    function renderMap() {
        const color = document.getElementById('colorPicker').value;
        const mode = document.getElementById('styleMode').value;
        const depth = parseInt(document.getElementById('depthRange').value);

        // é‡ç»„ Markdownï¼šéå†è¡Œï¼Œå¦‚æœè¯¥è¡Œ index åœ¨ checkedIndices ä¸­ï¼Œåˆ™åŠ æ ·å¼
        const finalMarkdown = parsedLines.map(item => {
            if (item.type !== 'node' || !checkedIndices.has(item.index)) {
                return item.originalLine || item.text; // è¿”å›åŸæ ·
            }

            // ç”Ÿæˆæ ·å¼
            let style = "";
            if (mode === 'text') {
                style = `color: ${color}; font-weight: 900; font-size: 1.15em;`;
            } else if (mode === 'background') {
                style = `background-color: ${color}40; color: #000; padding: 2px 5px; border-radius: 4px; font-weight: bold;`;
            } else if (mode === 'border') {
                style = `border: 2px solid ${color}; padding: 2px 6px; border-radius: 8px; color: ${color}; font-weight: bold; background: white;`;
            }

            // æ›¿æ¢æ–‡æœ¬å†…å®¹ä¸º HTML (ä¿ç•™åŸæœ¬çš„ Markdown ç¬¦å· # æˆ– -)
            // ç®€å•å¤„ç†ï¼šå°† cleanText åŒ…è£¹
            // è­¦å‘Šï¼šè¿™é‡Œè¦å°å¿ƒåªæ›¿æ¢æ–‡æœ¬éƒ¨åˆ†ï¼Œä¸ç ´åå‰é¢çš„ markdown ç¬¦å·
            // åˆ©ç”¨æˆ‘ä»¬è§£ææ—¶åˆ†ç¦»å‡ºçš„ç»“æ„ï¼š
            const prefix = item.originalLine.substring(0, item.originalLine.lastIndexOf(item.cleanText));
            return `${prefix}<span style="${style}">${item.cleanText}</span>`;
            
        }).join('\n');

        const { root, features } = transformer.transform(finalMarkdown);

        if (features.styles) loadCSS(features.styles);
        if (features.scripts) loadJS(features.scripts);

        if (mm) mm.destroy();

        mm = Markmap.create('#mindmap', {
            autoFit: true,
            fitRatio: 0.85,
            paddingX: 20,
            spacingHorizontal: 90,
            spacingVertical: 12,
            duration: 400,
            initialExpandLevel: depth,
        }, root);
    }

    // --- 4. å¯¼å‡ºé€æ˜æˆªå›¾åŠŸèƒ½ ---

    function exportImage() {
        const element = document.querySelector('#app');
        const btn = document.querySelector('.btn-export');
        const originalText = btn.innerText;
        btn.innerText = "â³ æ­£åœ¨ç”Ÿæˆ...";

        // é…ç½® html2canvas
        // å…³é”®ï¼šbackgroundColor: null ç¡®ä¿èƒŒæ™¯é€æ˜
        html2canvas(element, {
            backgroundColor: null, 
            scale: 2, // æé«˜æ¸…æ™°åº¦ (2å€å±)
            logging: false,
            // å¿½ç•¥ sidebar
            ignoreElements: (el) => el.classList.contains('sidebar')
        }).then(canvas => {
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.download = 'è’™å¤æ—æ€ç»´å¯¼å›¾.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
            
            btn.innerText = originalText;
        }).catch(err => {
            console.error(err);
            alert("å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•");
            btn.innerText = originalText;
        });
    }

    // å¯åŠ¨
    init();

</script>
</body>
</html>